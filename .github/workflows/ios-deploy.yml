name: Deploy iOS to App Store

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '4.0.0'
          architecture: 'x64'

      - name: Verify Flutter / Dart versions
        run: |
          flutter --version
          dart --version || true

      - name: Prepare certificates and provisioning profile (install script)
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_PROVISIONING_BASE64: ${{ secrets.IOS_PROVISIONING_BASE64 }}
        run: |
          set -e
          chmod +x ./scripts/install_ios_certs.sh || true
          IOS_P12_BASE64="$IOS_P12_BASE64" IOS_P12_PASSWORD="$IOS_P12_PASSWORD" IOS_PROVISIONING_BASE64="$IOS_PROVISIONING_BASE64" ./scripts/install_ios_certs.sh
        shell: bash

      - name: Inspect provisioning profile and identities
        run: |
          set -e
          echo "-- Codesigning identities --"
          security find-identity -v -p codesigning || true
          echo "-- Decoding provisioning profile --"
          mkdir -p /tmp/provision
          security cms -D -i "$HOME/Library/MobileDevice/Provisioning Profiles/app.mobileprovision" > /tmp/provision/profile.plist || true
          echo "Provisioning TeamIdentifier:"
          /usr/libexec/PlistBuddy -c "Print :TeamIdentifier:0" /tmp/provision/profile.plist || true
          echo "Provisioning UUID:"
          /usr/libexec/PlistBuddy -c "Print :UUID" /tmp/provision/profile.plist || true
        shell: bash

      - name: Flutter pub get
        run: flutter pub get

      - name: Build IPA
        run: |
          flutter build ipa --export-options-plist=ios/ExportOptions.plist --release
        shell: bash

      - name: Install Ruby & fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Install fastlane
        run: gem install fastlane -v 2.211.0

      - name: Decode App Store Connect API key JSON
        env:
          APP_STORE_CONNECT_API_KEY_JSON_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_JSON_BASE64 }}
        run: |
          set -e
          echo "$APP_STORE_CONNECT_API_KEY_JSON_BASE64" | base64 --decode > ./app_store_connect_api_key.json
          echo "Wrote app_store_connect_api_key.json"
        shell: bash

      - name: Upload to App Store (fastlane)
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_PATH: ./app_store_connect_api_key.json
        run: |
          set -e
          ls -l build/ios/ipa || true
          IPA_PATH=$(ls build/ios/ipa/*.ipa | head -n1)
          if [ -z "$IPA_PATH" ]; then echo "No IPA found"; exit 1; fi
          # Use fastlane deliver with API key JSON
          bundle exec fastlane deliver --ipa "$IPA_PATH" --api_key_path ./app_store_connect_api_key.json --skip_screenshots true --skip_metadata true --force
        shell: bash
